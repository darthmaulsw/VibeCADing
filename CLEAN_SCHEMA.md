# VibeCADing - Database Schema

## Overview
Simple 3D model generation and storage system using Supabase.

---

## Tables

### `users`
Stores user accounts.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Unique user identifier (auto-generated) |
| `username` | TEXT | Username for login (unique) |
| `password` | TEXT | Hashed password |

**Example:**
```sql
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  username text UNIQUE NOT NULL,
  password text NOT NULL
);
```

---

### `models`
Stores 3D models generated by users.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Unique model identifier (auto-generated) |
| `name` | TEXT | Model name/title |
| `user_id` | UUID | Foreign key to users table |
| `glb_file_url` | TEXT | URL to GLB file (from Hunyuan CDN) |

**Example:**
```sql
CREATE TABLE models (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  glb_file_url text
);
```

---

## Relationships

```
users (1) ──< models (many)
  └─ One user can have many models
  └─ When user is deleted, their models are deleted too (CASCADE)
```

---

## Security (RLS)

**Note:** Currently using permissive policies for development (allows all access).

```sql
-- Allow anyone to read/write users
CREATE POLICY "Allow users table access"
  ON users FOR ALL
  TO authenticated, anon
  USING (true)
  WITH CHECK (true);

-- Allow anyone to read/write models
CREATE POLICY "Allow models access"
  ON models FOR ALL
  TO authenticated, anon
  USING (true)
  WITH CHECK (true);
```

**For production:** Should restrict to authenticated users only and use JWT-based auth.

---

## How It Works

### 1. User Creation
```typescript
// Frontend stores user ID in localStorage
localStorage.setItem('3d_system_user_id', 'user-uuid-here');
```

### 2. Generate 3D Model
```typescript
// User captures photos → Hunyuan generates GLB
const glbUrl = 'https://tencent-hunyuan3d-2.hf.space/file=/tmp/gradio/abc.glb';
```

### 3. Save to Database
```typescript
// Save just the URL (super fast, no file upload)
await supabase
  .from('models')
  .insert({
    name: 'My Model',
    user_id: userId,
    glb_file_url: glbUrl
  });
```

### 4. Load Models
```typescript
// Get all user's models
const { data } = await supabase
  .from('models')
  .select('*')
  .eq('user_id', userId)
  .order('id', { ascending: false });
```

### 5. Display in 3D
```typescript
// Three.js loads GLB directly from stored URL
const loader = new GLTFLoader();
loader.load(model.glb_file_url, (gltf) => {
  scene.add(gltf.scene);
});
```

---

## Key Design Decisions

### ✅ Store URLs, Not Files
- **Fast:** Saves in ~0.1s instead of 30+ seconds
- **Simple:** No file upload/download complexity
- **Cheap:** No storage costs (just stores text)
- **Trade-off:** URLs may expire eventually

### ✅ Custom Authentication
- Uses `localStorage` for user ID instead of Supabase Auth
- Simpler for development
- Should upgrade to proper JWT auth for production

### ✅ Minimal Schema
- Only essential fields
- No timestamps unless needed
- No metadata unless needed
- Easy to understand and maintain

---

## Database Diagram

```
┌─────────────────┐
│     users       │
├─────────────────┤
│ id (PK)         │──┐
│ username        │  │
│ password        │  │
└─────────────────┘  │
                     │
                     │ (one-to-many)
                     │
┌─────────────────┐  │
│    models       │  │
├─────────────────┤  │
│ id (PK)         │  │
│ name            │  │
│ user_id (FK)    │←─┘
│ glb_file_url    │
└─────────────────┘
```

---

## API Examples

### Save a Model
```typescript
import { quickSaveModel } from './lib/quickStorage';

const model = await quickSaveModel(
  'https://hunyuan.../model.glb',
  'Teddy Bear',
  userId
);
```

### Get User's Models
```typescript
import { getUserModels } from './lib/quickStorage';

const models = await getUserModels(userId);
// Returns: Array<{ id, name, user_id, glb_file_url }>
```

### Delete a Model
```typescript
import { deleteModel } from './lib/quickStorage';

const success = await deleteModel(modelId, userId);
```

---

## Migration Scripts

### Setup Database (Run Once)

**1. Create tables:**
```sql
-- Users table
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  username text UNIQUE NOT NULL,
  password text NOT NULL
);

-- Models table
CREATE TABLE models (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  glb_file_url text
);

-- Indexes
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_models_user_id ON models(user_id);
```

**2. Enable RLS:**
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE models ENABLE ROW LEVEL SECURITY;
```

**3. Add policies:**
```sql
-- Permissive policies for development
CREATE POLICY "Allow users table access"
  ON users FOR ALL
  TO authenticated, anon
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Allow models access"
  ON models FOR ALL
  TO authenticated, anon
  USING (true)
  WITH CHECK (true);
```

---

## Performance

| Operation | Time | Notes |
|-----------|------|-------|
| Save model | ~0.1s | Just stores URL |
| Load models | ~0.2s | Database query |
| Render 3D preview | 1-3s | Loads GLB from Hunyuan |
| Generate new model | 2-5min | Depends on quality setting |

---

## Storage Costs

**Current:** $0/month
- No file storage (uses external URLs)
- Only stores text in database
- Supabase free tier is plenty

**If adding permanent storage later:**
- Download GLB (~5-20MB each)
- Upload to Supabase Storage
- ~$0.10/GB/month

---

## Future Enhancements

### Phase 1 (Optional)
- [ ] Add thumbnail generation
- [ ] Add model tags/categories
- [ ] Add "favorite" feature
- [ ] Add search functionality

### Phase 2 (When Needed)
- [ ] Permanent storage (download + backup to Supabase)
- [ ] JWT authentication
- [ ] Stricter RLS policies
- [ ] Model versioning
- [ ] Sharing/collaboration

---

## Tech Stack

- **Database:** Supabase (PostgreSQL)
- **Storage:** Hunyuan CDN (temporary) + Supabase Storage (future)
- **Frontend:** React + TypeScript
- **3D Rendering:** Three.js
- **3D Generation:** Hunyuan 3D API (Tencent)
- **Background Removal:** @imgly/background-removal

---

## Contact

For questions about the schema, see:
- `/home/samanthabrown/VibeCADing/QUICK_STORAGE_GUIDE.md` - Implementation details
- `/home/samanthabrown/VibeCADing/styled-pages/src/lib/quickStorage.ts` - Code

